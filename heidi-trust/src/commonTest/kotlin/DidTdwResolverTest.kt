import ch.ubique.heidi.trust.didtdw.DidTdwResolver
import kotlin.test.Test
import kotlin.test.assertNotNull

class DidTdwResolverTest {
    @Test
    fun testSwiyu1() {
        val jsonl = """
            ["1-QmeoKrpAHbvnBGitDwdL2TFsjSmPdTcgwrvci65ejWZeE1","2025-02-03T13:46:46Z",{"method":"did:tdw:0.3","scid":"QmPEZPhDFR4nEYSFK5bMnvECqdpf1tPTPJuWs9QrMjCumw","updateKeys":["z6MkwGwfbexiUCGeyrdS2fsBCuTsm8b9JJyofvvphuJ5yq4f"]},{"value":{"@context":["https://www.w3.org/ns/did/v1","https://w3id.org/security/suites/jws-2020/v1"],"id":"did:tdw:QmPEZPhDFR4nEYSFK5bMnvECqdpf1tPTPJuWs9QrMjCumw:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:9a5559f0-b81c-4368-a170-e7b4ae424527","authentication":["did:tdw:QmPEZPhDFR4nEYSFK5bMnvECqdpf1tPTPJuWs9QrMjCumw:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:9a5559f0-b81c-4368-a170-e7b4ae424527#auth-key-857403c5-e637-48da-86e0-b5b46d995145"],"assertionMethod":["did:tdw:QmPEZPhDFR4nEYSFK5bMnvECqdpf1tPTPJuWs9QrMjCumw:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:9a5559f0-b81c-4368-a170-e7b4ae424527#assert-key-f4bc032f-bfe0-4bab-acb3-bc3ef7fb3400","did:tdw:QmPEZPhDFR4nEYSFK5bMnvECqdpf1tPTPJuWs9QrMjCumw:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:9a5559f0-b81c-4368-a170-e7b4ae424527#assert-key-b720c10d-34be-4e2e-9d87-cecdf8e6a00f","did:tdw:QmPEZPhDFR4nEYSFK5bMnvECqdpf1tPTPJuWs9QrMjCumw:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:9a5559f0-b81c-4368-a170-e7b4ae424527#assert-key-c02a1676-ab19-491c-b0fa-3703ea269c07"],"verificationMethod":[{"id":"did:tdw:QmPEZPhDFR4nEYSFK5bMnvECqdpf1tPTPJuWs9QrMjCumw:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:9a5559f0-b81c-4368-a170-e7b4ae424527#auth-key-857403c5-e637-48da-86e0-b5b46d995145","controller":"did:tdw:QmPEZPhDFR4nEYSFK5bMnvECqdpf1tPTPJuWs9QrMjCumw:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:9a5559f0-b81c-4368-a170-e7b4ae424527","type":"JsonWebKey2020","publicKeyJwk":{"kty":"EC","crv":"P-256","x":"-vyk2CRIGhkVIHOs635MuecwGh0Up1vWrfXAcNYhLzE","y":"7N0RuWkLNjAzlrZjLcIYpiYJwd9Dbx8ihgSZQUWIBug"}},{"id":"did:tdw:QmPEZPhDFR4nEYSFK5bMnvECqdpf1tPTPJuWs9QrMjCumw:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:9a5559f0-b81c-4368-a170-e7b4ae424527#assert-key-f4bc032f-bfe0-4bab-acb3-bc3ef7fb3400","controller":"did:tdw:QmPEZPhDFR4nEYSFK5bMnvECqdpf1tPTPJuWs9QrMjCumw:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:9a5559f0-b81c-4368-a170-e7b4ae424527","type":"JsonWebKey2020","publicKeyJwk":{"kty":"EC","crv":"P-256","x":"zDTIeVtBZGBFH7l5k_soE79FEgeqtB9cJZc_jjwE1vc","y":"eTGNVxoW54gEHPrFTpOg2zNFLWcxLHs9vi85sXxMhXA"}},{"id":"did:tdw:QmPEZPhDFR4nEYSFK5bMnvECqdpf1tPTPJuWs9QrMjCumw:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:9a5559f0-b81c-4368-a170-e7b4ae424527#assert-key-b720c10d-34be-4e2e-9d87-cecdf8e6a00f","controller":"did:tdw:QmPEZPhDFR4nEYSFK5bMnvECqdpf1tPTPJuWs9QrMjCumw:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:9a5559f0-b81c-4368-a170-e7b4ae424527","type":"JsonWebKey2020","publicKeyJwk":{"kty":"EC","crv":"P-256","x":"_UOKP2X1Kft8njOmKUxh0UK7F0fVGM1kc78-YYXTpEw","y":"rYUhY-ntvpoArenVCFMI6Iw1D9sTsz6_NMT8CWiX7mw"}},{"id":"did:tdw:QmPEZPhDFR4nEYSFK5bMnvECqdpf1tPTPJuWs9QrMjCumw:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:9a5559f0-b81c-4368-a170-e7b4ae424527#assert-key-c02a1676-ab19-491c-b0fa-3703ea269c07","controller":"did:tdw:QmPEZPhDFR4nEYSFK5bMnvECqdpf1tPTPJuWs9QrMjCumw:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:9a5559f0-b81c-4368-a170-e7b4ae424527","type":"JsonWebKey2020","publicKeyJwk":{"kty":"EC","crv":"P-256","x":"A6uZ-HIqDWarkOHruGPaG6l2FRv9CSVCdQ96KV--zHI","y":"we1SEu2zQFi9yXH9JcnAEs64l1t4_Qv181fyvns-9wE"}}]}},[{"type":"DataIntegrityProof","cryptosuite":"eddsa-jcs-2022","created":"2025-02-03T13:46:46Z","verificationMethod":"did:key:z6MkwGwfbexiUCGeyrdS2fsBCuTsm8b9JJyofvvphuJ5yq4f#z6MkwGwfbexiUCGeyrdS2fsBCuTsm8b9JJyofvvphuJ5yq4f","proofPurpose":"authentication","challenge":"1-QmeoKrpAHbvnBGitDwdL2TFsjSmPdTcgwrvci65ejWZeE1","proofValue":"zX5HhpnVaLjEvgS3SKvPUxUZKYHQWbpVVaXcKRjfLZMkmyBBEgetr7XZiBGJ89t1UX8hx8G7MxVCbBg7xpMpeHBF"}]]
        """.trimIndent()
        val resolver = DidTdwResolver.parse(jsonl.split('\n'))

        val entry = resolver.resolveLatest(verify = true)
        assertNotNull(entry)
    }

    @Test
    fun testSwiyu2() {
        val jsonl = """
            ["1-QmdJiFHQ3gHMyRUnW6Rri6hHwKRrQUJadBRoirLZUJtsmC","2025-01-31T09:35:11Z",{"method":"did:tdw:0.3","scid":"QmWrXWFEDenvoYWFXxSQGFCa6Pi22Cdsg2r6weGhY2ChiQ","updateKeys":["z6MkrU7wPQwBXsnYzWVJMWbvq61ZeDib6v9aQ3DpXu7qWagv"]},{"value":{"@context":["https://www.w3.org/ns/did/v1","https://w3id.org/security/suites/jws-2020/v1"],"id":"did:tdw:QmWrXWFEDenvoYWFXxSQGFCa6Pi22Cdsg2r6weGhY2ChiQ:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:2e246676-209a-4c21-aceb-721f8a90b212","authentication":["did:tdw:QmWrXWFEDenvoYWFXxSQGFCa6Pi22Cdsg2r6weGhY2ChiQ:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:2e246676-209a-4c21-aceb-721f8a90b212#auth-key-01"],"assertionMethod":["did:tdw:QmWrXWFEDenvoYWFXxSQGFCa6Pi22Cdsg2r6weGhY2ChiQ:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:2e246676-209a-4c21-aceb-721f8a90b212#assert-key-01"],"verificationMethod":[{"id":"did:tdw:QmWrXWFEDenvoYWFXxSQGFCa6Pi22Cdsg2r6weGhY2ChiQ:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:2e246676-209a-4c21-aceb-721f8a90b212#auth-key-01","controller":"did:tdw:QmWrXWFEDenvoYWFXxSQGFCa6Pi22Cdsg2r6weGhY2ChiQ:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:2e246676-209a-4c21-aceb-721f8a90b212","type":"JsonWebKey2020","publicKeyJwk":{"kty":"EC","crv":"P-256","x":"D3nYTvdvNL0wRvm4bu92CjntEpDfI8bfQdQhaaD6Qv8","y":"oLe56pmgQWmhAo5eviw2XFNHjmGhepy9RzQSseUXGIU","kid":"auth-key-01"}},{"id":"did:tdw:QmWrXWFEDenvoYWFXxSQGFCa6Pi22Cdsg2r6weGhY2ChiQ:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:2e246676-209a-4c21-aceb-721f8a90b212#assert-key-01","controller":"did:tdw:QmWrXWFEDenvoYWFXxSQGFCa6Pi22Cdsg2r6weGhY2ChiQ:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:2e246676-209a-4c21-aceb-721f8a90b212","type":"JsonWebKey2020","publicKeyJwk":{"kty":"EC","crv":"P-256","x":"1fwnwoN8zatr6kD_bvwY2zQDV4D6blE7mzTliQF11Jc","y":"9-cDZlPqXVlJnE0rcUUyy7P_15x7RLE-jiNGqHA9FP4","kid":"assert-key-01"}}]}},[{"type":"DataIntegrityProof","cryptosuite":"eddsa-jcs-2022","created":"2025-01-31T09:35:11Z","verificationMethod":"did:key:z6MkrU7wPQwBXsnYzWVJMWbvq61ZeDib6v9aQ3DpXu7qWagv#z6MkrU7wPQwBXsnYzWVJMWbvq61ZeDib6v9aQ3DpXu7qWagv","proofPurpose":"authentication","challenge":"1-QmdJiFHQ3gHMyRUnW6Rri6hHwKRrQUJadBRoirLZUJtsmC","proofValue":"z2HuP8d1Wk6mLZpp2QmxywGNSDAi2CxfgoE7FJoeB1DSfUfg2kUyokAaea1Bqz5Q6L5FaukkD1KdxUpU45z1TUB3R"}]]
            ["2-QmaZ4qosmE14mFfrZryRcbdF7xzcKtmsx63j8St8XcSXk9","2025-06-19T05:58:07Z",{"updateKeys":["z6MkqEoXQWnL8ecqWqLUDHgDhouF8Wb63juqG3uxBXg4iYZE"]},{"value":{"@context":["https://www.w3.org/ns/did/v1","https://w3id.org/security/suites/jws-2020/v1"],"id":"did:tdw:QmWrXWFEDenvoYWFXxSQGFCa6Pi22Cdsg2r6weGhY2ChiQ:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:2e246676-209a-4c21-aceb-721f8a90b212","authentication":["did:tdw:QmWrXWFEDenvoYWFXxSQGFCa6Pi22Cdsg2r6weGhY2ChiQ:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:2e246676-209a-4c21-aceb-721f8a90b212#auth-key-01","did:tdw:QmWrXWFEDenvoYWFXxSQGFCa6Pi22Cdsg2r6weGhY2ChiQ:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:2e246676-209a-4c21-aceb-721f8a90b212#auth-key-02"],"assertionMethod":["did:tdw:QmWrXWFEDenvoYWFXxSQGFCa6Pi22Cdsg2r6weGhY2ChiQ:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:2e246676-209a-4c21-aceb-721f8a90b212#assert-key-01","did:tdw:QmWrXWFEDenvoYWFXxSQGFCa6Pi22Cdsg2r6weGhY2ChiQ:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:2e246676-209a-4c21-aceb-721f8a90b212#assert-key-02"],"verificationMethod":[{"id":"did:tdw:QmWrXWFEDenvoYWFXxSQGFCa6Pi22Cdsg2r6weGhY2ChiQ:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:2e246676-209a-4c21-aceb-721f8a90b212#auth-key-01","controller":"did:tdw:QmWrXWFEDenvoYWFXxSQGFCa6Pi22Cdsg2r6weGhY2ChiQ:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:2e246676-209a-4c21-aceb-721f8a90b212","type":"JsonWebKey2020","publicKeyJwk":{"kty":"EC","crv":"P-256","kid":"auth-key-01","x":"D3nYTvdvNL0wRvm4bu92CjntEpDfI8bfQdQhaaD6Qv8","y":"oLe56pmgQWmhAo5eviw2XFNHjmGhepy9RzQSseUXGIU"}},{"id":"did:tdw:QmWrXWFEDenvoYWFXxSQGFCa6Pi22Cdsg2r6weGhY2ChiQ:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:2e246676-209a-4c21-aceb-721f8a90b212#auth-key-02","controller":"did:tdw:QmWrXWFEDenvoYWFXxSQGFCa6Pi22Cdsg2r6weGhY2ChiQ:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:2e246676-209a-4c21-aceb-721f8a90b212","type":"JsonWebKey2020","publicKeyJwk":{"kty":"EC","crv":"P-256","kid":"auth-key-02","x":"hoFI0keVdxjBPlBy2XZFMmYOc77t1_-rLeqemDl9eE8","y":"1grlPKdSeO5larnfEBOMLOVlQsVy7EdOkCcDKtV8bSM"}},{"id":"did:tdw:QmWrXWFEDenvoYWFXxSQGFCa6Pi22Cdsg2r6weGhY2ChiQ:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:2e246676-209a-4c21-aceb-721f8a90b212#assert-key-01","controller":"did:tdw:QmWrXWFEDenvoYWFXxSQGFCa6Pi22Cdsg2r6weGhY2ChiQ:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:2e246676-209a-4c21-aceb-721f8a90b212","type":"JsonWebKey2020","publicKeyJwk":{"kty":"EC","crv":"P-256","kid":"assert-key-01","x":"1fwnwoN8zatr6kD_bvwY2zQDV4D6blE7mzTliQF11Jc","y":"9-cDZlPqXVlJnE0rcUUyy7P_15x7RLE-jiNGqHA9FP4"}},{"id":"did:tdw:QmWrXWFEDenvoYWFXxSQGFCa6Pi22Cdsg2r6weGhY2ChiQ:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:2e246676-209a-4c21-aceb-721f8a90b212#assert-key-02","controller":"did:tdw:QmWrXWFEDenvoYWFXxSQGFCa6Pi22Cdsg2r6weGhY2ChiQ:identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:2e246676-209a-4c21-aceb-721f8a90b212","type":"JsonWebKey2020","publicKeyJwk":{"kty":"EC","crv":"P-256","kid":"assert-key-02","x":"epI4RIrbjW8IvQhzWkzX03gwWtlXsDExIcCaHiQNBSw","y":"gn-d4SuUtcuHmH8plz05vUflXhibaDBj9RFn7ocgozs"}}]}},[{"type":"DataIntegrityProof","cryptosuite":"eddsa-jcs-2022","created":"2025-06-19T05:58:07Z","verificationMethod":"did:key:z6MkrU7wPQwBXsnYzWVJMWbvq61ZeDib6v9aQ3DpXu7qWagv#z6MkrU7wPQwBXsnYzWVJMWbvq61ZeDib6v9aQ3DpXu7qWagv","proofPurpose":"authentication","challenge":"2-QmaZ4qosmE14mFfrZryRcbdF7xzcKtmsx63j8St8XcSXk9","proofValue":"z22FkwFQYinHLYauXnMp8rZhaAYxvAS3M25UXNG1XvBuQbP9m2DcBX1aaSvtjTsPxhDQAPtutC4TtE9EZZSCRcNmC"}]]
        """.trimIndent()

        val resolver = DidTdwResolver.parse(jsonl.split('\n'))

        val entry = resolver.resolveLatest(verify = true)
        assertNotNull(entry)
    }
}